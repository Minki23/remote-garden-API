<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸ¥ WebRTC Dummy Video</title>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      background: #f0f0f0;
    }
    video { 
      width: 720px; 
      height: 540px;
      background: black; 
      border: 2px solid #333;
      border-radius: 8px;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }
  </style>
</head>
<body>
  <h2>ğŸ© Dummy Video przez WebRTC</h2>
  <div class="status" id="status">ğŸ”„ ÅÄ…czenie...</div>
  <video id="video" autoplay playsinline muted></video>

  <script>
    const video = document.getElementById("video");
    const status = document.getElementById("status");
    
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.onconnectionstatechange = () => {
      console.log("ğŸ”— Stan poÅ‚Ä…czenia:", pc.connectionState);
      status.textContent = `ğŸ”— Stan: ${pc.connectionState}`;
    };

    pc.oniceconnectionstatechange = () => {
      console.log("ğŸ§Š Stan ICE:", pc.iceConnectionState);
    };

    pc.ontrack = (event) => {
      console.log("ğŸ¥ Otrzymano track:", event.track);
      status.textContent = "âœ… Stream otrzymany!";
      if (event.streams && event.streams[0]) {
        video.srcObject = event.streams[0];
        console.log("ğŸ“º Video ÅºrÃ³dÅ‚o ustawione");
      } else {
        const stream = new MediaStream([event.track]);
        video.srcObject = stream;
        console.log("ğŸ“º Video ÅºrÃ³dÅ‚o ustawione (fallback)");
      }
    };

    let iceCandidatesComplete = false;
    let offerSent = false;

    pc.onicecandidate = (event) => {
      console.log("ğŸ§Š ICE Candidate:", event.candidate);
      if (event.candidate === null && !iceCandidatesComplete && !offerSent) {
        iceCandidatesComplete = true;
        offerSent = true;
        console.log("ğŸ§Š ICE gathering zakoÅ„czone");
        sendOffer();
      }
    };

    pc.addTransceiver("video", { direction: "recvonly" });

    async function sendOffer() {
      try {
        console.log("ğŸ“¤ WysyÅ‚anie oferty do serwera...");
        const res = await fetch("http://localhost:3000/live/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type
          })
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const answer = await res.json();
        if (pc.signalingState === "have-local-offer") {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
          console.log("âœ… RemoteDescription ustawiony");
          status.textContent = "âœ… PoÅ‚Ä…czenie nawiÄ…zane, oczekiwanie na stream...";
        } else {
          console.warn("âš ï¸ Pomijam setRemoteDescription - zÅ‚y stan:", pc.signalingState);
          status.textContent = "âš ï¸ PoÅ‚Ä…czenie juÅ¼ aktywne";
        }
      } catch (error) {
        console.error("âŒ BÅ‚Ä…d:", error);
        status.textContent = `âŒ BÅ‚Ä…d: ${error.message}`;
      }
    }

    async function start() {
      try {
        console.log("ğŸ“¡ Tworzenie oferty...");
        status.textContent = "ğŸ“¡ Tworzenie oferty...";
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        console.log("ğŸ“© Oferta ustawiona, czekam na ICE candidates...");
        status.textContent = "ğŸ“© Oferta utworzona, zbieranie ICE candidates...";
        setTimeout(() => {
          if (!iceCandidatesComplete && !offerSent) {
            console.log("â° Timeout ICE gathering, wysyÅ‚am ofertÄ™");
            offerSent = true;
            sendOffer();
          }
        }, 3000);
      } catch (error) {
        console.error("âŒ BÅ‚Ä…d tworzenia oferty:", error);
        status.textContent = `âŒ BÅ‚Ä…d: ${error.message}`;
      }
    }

    start();
  </script>
</body>
</html>
